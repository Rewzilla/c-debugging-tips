# How to use scan-build

Scan-build is a static analyzer which examines a program _as it's being compiled_ to identify bugs.  Because scan-build has access to all the program structure information generated by the compiler, it can detect even very subtle bugs which require complex conditions in order to trigger.  If you are struggling to track down a tricky bug which other tools can't identify, scan-build may be able to help.

Scan-build can be invoked by simply adding `scan-build` at the beginning of the command when you compile your code.  For instance...

```
scan-build gcc yourcode.c
```

When run like this, scan-build will generate a set of HTML (webpage) files describing each bug in great detail.  By default these are stored in a temoporary directory like `/tmp/scan-build-2024-05-14-153955-1542-1`.

If you are running scan-build _locally_ (such as in a VM on your own computer), then you can simply run `scan-view /tmp/scan-build-.....` to view them.  This will open a web browser where you can review the results.

These files are not easily viewable on the command line though, so if you are running scan-build through SSH on a remote machine (such as the `cs.dsunix.net` or `dev.hostbin.org` servers), you will need to download the results first in order to view them locally.  A tool like SCP (secure copy) would be ideal for this.  If you are using Windows then [WinSCP](https://winscp.net/eng/download.php) can be used to download the result files.  You may then open the `index.html` file in that directory locally in order to view the results.

## Example

Consider the following program which is meant to create, setup, and delete "items".  As we can see the program runs in a loop, each time asking the user what action to take (by inputing a number 1-3), and then taking that action.

 - When the user enters `1`, the program will allocate a bnew `struct item` structure.
 - When the user enters `2`, the program will set the `id` and `desc` members of that structure.
 - When the user enters `3`, the program will free the structure, thus deleting it.

```c
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

struct item {
	int id;
	char *desc;
};

int main() {

	int choice;
	struct item *p;

	while (1) {

		printf("(1) Create, (2) Setup, (3) Delete: ");
		scanf("%d", &choice);

		switch (choice) {
		case 1:
			p = malloc(sizeof(struct item));
			break;
		case 2:
			p->id = 1234;
			p->desc = strdup("Some random thing");
			break;
		case 3:
			free(p);
			break;
		}

	}

}
```

At first glance this program looks reasonable, but notice that several bugs exist which we can trigger by invoking the actions in an unexpected order.  For instance, if we attempt to delete the object twice in a row the program crashes with a cryptic "double free" error message.

```
andrew@dev:~$ gcc example.c
andrew@dev:~$ ./a.out 
(1) Create, (2) Setup, (3) Delete: 1
(1) Create, (2) Setup, (3) Delete: 3
(1) Create, (2) Setup, (3) Delete: 3
free(): double free detected in tcache 2
Aborted
```

Although in this case it is clear what went wrong, for more complex software (such as those using linked-lists) these bugs can be maddening to identify.  Let's see if scan-build can help us determine all the potential ways that this code may fail!

First, we compile the code with scan-build observing the process.

```
andrew@dev:~$ scan-build gcc example.c
scan-build: Using '/usr/lib/llvm-14/bin/clang' for static analysis
example.c:25:10: warning: Access to field 'id' results in a dereference of an undefined pointer value (loaded from variable 'p') [core.NullDereference]
                        p->id = 1234;
                        ~     ^
example.c:25:10: warning: Use of memory after it is freed [unix.Malloc]
                        p->id = 1234;
                        ~~~~~ ^
example.c:29:4: warning: Attempt to free released memory [unix.Malloc]
                        free(p);
                        ^~~~~~~
example.c:29:4: warning: 1st function call argument is an uninitialized value [core.CallAndMessage]
                        free(p);
                        ^~~~~~~
4 warnings generated.
scan-build: Analysis run complete.
scan-build: 4 bugs found.
scan-build: Run 'scan-view /tmp/scan-build-2024-05-14-160305-1736-1' to examine bug reports.
```

We can see that scan-build detected several bugs (use of free'd memory, uninitialized variable usage, etc), however it's not immediatly clear how or why that occured.  In the command line output scan-build indicated there was a problem but didn't explain why.  To see a full explaination, run `scan-view /tmp/scan-build-2024-05-14-160305-1736-1`. Remember that if you are running scan-build on a remote server, you will instead need to first download that folder of files and then open the `index.html` file within!

Once open, you should see a list of bugs like this:

![scan-build output index file showing four bugs](../images/scan-build-1.png)

## Requirements
